name: Helm CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  lint-validate-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: List changed charts
        id: list
        run: |
          changed=$(ct list-changed --config .github/ct-config.yaml || true)
          echo "changed=$changed" >> $GITHUB_OUTPUT
          echo "Changed charts:\n$changed"

      - name: Lint changed charts
        if: steps.list.outputs.changed != ''
        run: ct lint --config .github/ct-config.yaml

      - name: Create KinD cluster
        if: steps.list.outputs.changed != ''
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: charts-ci

      - name: Install kubeconform
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz | sudo tar -xz -C /usr/local/bin kubeconform
          kubeconform -v

      - name: Render and kubeconform validate charts
        if: steps.list.outputs.changed != ''
        run: |
          set -euo pipefail
          for chart in $(ct list-changed --config .github/ct-config.yaml); do
            echo "Rendering $chart"
            helm template test-$RANDOM "$chart" -f ci/ct-values-common.yaml | kubeconform -strict -summary -ignore-missing-schemas || exit 1
          done

      - name: Install changed charts into KinD
        if: steps.list.outputs.changed != ''
        run: ct install --config .github/ct-config.yaml
